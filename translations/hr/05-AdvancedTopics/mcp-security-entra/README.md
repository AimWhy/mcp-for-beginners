<!--
CO_OP_TRANSLATOR_METADATA:
{
  "original_hash": "6e562d7e5a77c8982da4aa8f762ad1d8",
  "translation_date": "2025-07-02T10:01:10+00:00",
  "source_file": "05-AdvancedTopics/mcp-security-entra/README.md",
  "language_code": "hr"
}
-->
# Osiguravanje AI tijekova rada: Entra ID autentikacija za Model Context Protocol (MCP) poslu≈æitelje

## Uvod  
Osiguravanje va≈°eg Model Context Protocol (MCP) poslu≈æitelja jednako je va≈æno kao i zakljuƒçavanje ulaznih vrata va≈°eg doma. Ostaviti MCP poslu≈æitelj otvorenim znaƒçi izlagati svoje alate i podatke neovla≈°tenom pristupu, ≈°to mo≈æe dovesti do sigurnosnih propusta. Microsoft Entra ID pru≈æa sna≈æno rje≈°enje za upravljanje identitetom i pristupom u oblaku, poma≈æuƒái da samo ovla≈°teni korisnici i aplikacije mogu komunicirati s va≈°im MCP poslu≈æiteljem. U ovom dijelu nauƒçit ƒáete kako za≈°tititi svoje AI tijekove rada koristeƒái Entra ID autentikaciju.

## Ciljevi uƒçenja  
Na kraju ovog dijela moƒái ƒáete:

- Razumjeti va≈ænost osiguranja MCP poslu≈æitelja.
- Objasniti osnove Microsoft Entra ID i OAuth 2.0 autentikacije.
- Prepoznati razliku izmeƒëu javnih i povjerljivih klijenata.
- Implementirati Entra ID autentikaciju u lokalnim (javni klijent) i udaljenim (povjerljivi klijent) MCP poslu≈æiteljskim scenarijima.
- Primijeniti najbolje sigurnosne prakse pri razvoju AI tijekova rada.

## Sigurnost i MCP

Ba≈° kao ≈°to ne biste ostavili ulazna vrata svog doma otkljuƒçana, ne biste trebali ostaviti MCP poslu≈æitelj otvoren za pristup svima. Osiguranje va≈°ih AI tijekova rada kljuƒçno je za izgradnju robusnih, pouzdanih i sigurnih aplikacija. Ovaj ƒáe vas odjeljak upoznati s kori≈°tenjem Microsoft Entra ID za za≈°titu va≈°ih MCP poslu≈æitelja, osiguravajuƒái da samo ovla≈°teni korisnici i aplikacije mogu pristupiti va≈°im alatima i podacima.

## Za≈°to je sigurnost va≈æna za MCP poslu≈æitelje

Zamislite da va≈° MCP poslu≈æitelj ima alat koji mo≈æe slati e-po≈°tu ili pristupiti bazi podataka korisnika. Nesiguran poslu≈æitelj znaƒçio bi da svatko mo≈æe koristiti taj alat, ≈°to mo≈æe dovesti do neovla≈°tenog pristupa podacima, ne≈æeljene po≈°te ili drugih zlonamjernih aktivnosti.

Implementacijom autentikacije osiguravate da je svaki zahtjev prema va≈°em poslu≈æitelju provjeren, potvrƒëujuƒái identitet korisnika ili aplikacije koji ≈°alju zahtjev. Ovo je prvi i najva≈æniji korak u osiguravanju va≈°ih AI tijekova rada.

## Uvod u Microsoft Entra ID

[**Microsoft Entra ID**](https://adoption.microsoft.com/microsoft-security/entra/) je usluga za upravljanje identitetima i pristupom u oblaku. Zamislite ga kao univerzalnog ƒçuvara sigurnosti za va≈°e aplikacije. On upravlja slo≈æenim procesom provjere identiteta korisnika (autentikacija) i odreƒëivanjem ≈°to im je dopu≈°teno raditi (autorizacija).

Kori≈°tenjem Entra ID-a mo≈æete:

- Omoguƒáiti siguran prijavu korisnicima.
- Za≈°tititi API-je i usluge.
- Upravljati pravilima pristupa s jednog mjesta.

Za MCP poslu≈æitelje, Entra ID pru≈æa pouzdano i ≈°iroko prihvaƒáeno rje≈°enje za upravljanje pristupom va≈°im poslu≈æiteljskim funkcionalnostima.

---

## Razumijevanje ƒçarolije: Kako funkcionira Entra ID autentikacija

Entra ID koristi otvorene standarde poput **OAuth 2.0** za upravljanje autentikacijom. Iako detalji mogu biti slo≈æeni, osnovni koncept je jednostavan i mo≈æe se razumjeti kroz analogiju.

### Nje≈æno upoznavanje s OAuth 2.0: Kljuƒç za parkiranje

Zamislite OAuth 2.0 kao uslugu parkiranja za va≈° automobil. Kada stignete u restoran, ne dajete parkirnom slu≈æbeniku glavni kljuƒç. Umjesto toga, dajete **kljuƒç za parkiranje** koji ima ograniƒçena dopu≈°tenja ‚Äî mo≈æe upaliti auto i zakljuƒçati vrata, ali ne mo≈æe otvoriti prtlja≈ænik ili pretinac za rukavice.

U ovoj analogiji:

- **Vi** ste **Korisnik**.
- **Va≈° automobil** je **MCP poslu≈æitelj** s vrijednim alatima i podacima.
- **Parkirni slu≈æbenik** je **Microsoft Entra ID**.
- **Osoblje za parkiranje** je **MCP klijent** (aplikacija koja poku≈°ava pristupiti poslu≈æitelju).
- **Kljuƒç za parkiranje** je **Access Token**.

Access token je siguran tekstualni niz koji MCP klijent dobiva od Entra ID-a nakon ≈°to se prijavite. Klijent zatim ≈°alje ovaj token poslu≈æitelju pri svakom zahtjevu. Poslu≈æitelj mo≈æe provjeriti token kako bi osigurao da je zahtjev legitiman i da klijent ima potrebne ovlasti, a da pritom nikada ne mora rukovati va≈°im stvarnim vjerodajnicama (poput lozinke).

### Tijek autentikacije

Evo kako proces funkcionira u praksi:

```mermaid
sequenceDiagram
    actor User as üë§ User
    participant Client as üñ•Ô∏è MCP Client
    participant Entra as üîê Microsoft Entra ID
    participant Server as üîß MCP Server

    Client->>+User: Please sign in to continue.
    User->>+Entra: Enters credentials (username/password).
    Entra-->>Client: Here is your access token.
    User-->>-Client: (Returns to the application)

    Client->>+Server: I need to use a tool. Here is my access token.
    Server->>+Entra: Is this access token valid?
    Entra-->>-Server: Yes, it is.
    Server-->>-Client: Token is valid. Here is the result of the tool.
```

### Uvod u Microsoft Authentication Library (MSAL)

Prije nego ≈°to zaronimo u kod, va≈æno je upoznati kljuƒçnu komponentu koju ƒáete vidjeti u primjerima: **Microsoft Authentication Library (MSAL)**.

MSAL je biblioteka koju je razvio Microsoft i koja programerima znatno olak≈°ava upravljanje autentikacijom. Umjesto da sami pi≈°ete sav slo≈æeni kod za rukovanje sigurnosnim tokenima, upravljanje prijavama i osvje≈æavanje sesija, MSAL obavlja sav taj te≈æak posao.

Preporuƒçuje se kori≈°tenje biblioteke poput MSAL jer:

- **Sigurna je:** Implementira industrijske standarde i najbolje sigurnosne prakse, smanjujuƒái rizik od ranjivosti u va≈°em kodu.
- **Pojednostavljuje razvoj:** Apstrahira slo≈æenost OAuth 2.0 i OpenID Connect protokola, omoguƒáujuƒái vam da s nekoliko redaka koda dodate robusnu autentikaciju u svoju aplikaciju.
- **Odr≈æava ju Microsoft:** Microsoft aktivno odr≈æava i a≈æurira MSAL kako bi se nosio s novim sigurnosnim prijetnjama i promjenama platformi.

MSAL podr≈æava ≈°irok raspon jezika i razvojnih okvira, ukljuƒçujuƒái .NET, JavaScript/TypeScript, Python, Java, Go, te mobilne platforme poput iOS-a i Androida. To znaƒçi da mo≈æete koristiti iste konzistentne obrasce autentikacije kroz cijeli svoj tehnolo≈°ki sloj.

Za vi≈°e informacija o MSAL-u, mo≈æete pogledati slu≈æbenu [MSAL preglednu dokumentaciju](https://learn.microsoft.com/entra/identity-platform/msal-overview).

---

## Osiguravanje va≈°eg MCP poslu≈æitelja s Entra ID: korak-po-korak vodiƒç

Sada ƒáemo proƒái kroz korake kako osigurati lokalni MCP poslu≈æitelj (onaj koji komunicira preko `stdio`):

**AuthenticationService.cs** koristi metodu **CreateAsync** za kreiranje instance **PublicClientApplication** s parametrima **clientId**, **tenantId** i **WithBroker**.  
Metoda **AcquireTokenAsync** je kljuƒçna. Prvo poku≈°ava tiho dobiti token (≈°to znaƒçi da korisnik neƒáe morati ponovno unositi podatke ako veƒá ima valjanu sesiju). Ako tihi token nije dostupan, zahtijeva interaktivnu prijavu korisnika.

```csharp
// Simplified for clarity
public static async Task<AuthenticationService> CreateAsync(ILogger<AuthenticationService> logger)
{
    var msalClient = PublicClientApplicationBuilder
        .Create(_clientId) // Your Application (client) ID
        .WithAuthority(AadAuthorityAudience.AzureAdMyOrg)
        .WithTenantId(_tenantId) // Your Directory (tenant) ID
        .WithBroker(new BrokerOptions(BrokerOptions.OperatingSystems.Windows))
        .Build();

    // ... cache registration ...

    return new AuthenticationService(logger, msalClient);
}

public async Task<string> AcquireTokenAsync()
{
    try
    {
        // Try silent authentication first
        var accounts = await _msalClient.GetAccountsAsync();
        var account = accounts.FirstOrDefault();

        AuthenticationResult? result = null;

        if (account != null)
        {
            result = await _msalClient.AcquireTokenSilent(_scopes, account).ExecuteAsync();
        }
        else
        {
            // If no account, or silent fails, go interactive
            result = await _msalClient.AcquireTokenInteractive(_scopes).ExecuteAsync();
        }

        return result.AccessToken;
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "An error occurred while acquiring the token.");
        throw; // Optionally rethrow the exception for higher-level handling
    }
}
```

U **Program.cs**, instancira se singleton za **AuthenticationService**, a zatim se koristi metoda **authService.AcquireTokenAsync()** za dobivanje valjanog pristupnog tokena. Ako je autentikacija uspje≈°na, koristi se token za poziv Microsoft Graph API-ja i dohvaƒáanje korisniƒçkih podataka.

```csharp
// Simplified for clarity
[McpServerTool(Name = "GetUserDetailsFromGraph")]
public static async Task<string> GetUserDetailsFromGraph(
    AuthenticationService authService)
{
    try
    {
        // This will trigger the authentication flow
        var accessToken = await authService.AcquireTokenAsync();

        // Use the token to create a GraphServiceClient
        var graphClient = new GraphServiceClient(
            new BaseBearerTokenAuthenticationProvider(new TokenProvider(authService)));

        var user = await graphClient.Me.GetAsync();

        return System.Text.Json.JsonSerializer.Serialize(user);
    }
    catch (Exception ex)
    {
        return $"Error: {ex.Message}";
    }
}
```

#### 3. Kako sve to funkcionira zajedno

1. Kada MCP klijent pozove alat `GetUserDetailsFromGraph`, koristi **AcquireTokenAsync** da dobije pristupni token.
2. Endpoint `/auth/callback` prima preusmjeravanje od Entra ID nakon ≈°to se korisnik autentificirao. Ovdje se zamjenjuje authorization code za pristupni i osvje≈æavajuƒái token.

```typescript
// Simplified for clarity
const app = express();
const { server } = createServer();
const provider = new EntraIdServerAuthProvider();

// Protect the SSE endpoint
app.get("/sse", requireBearerAuth({
  provider,
  requiredScopes: ["User.Read"]
}), async (req, res) => {
  // ... connect to the transport ...
});

// Protect the message endpoint
app.post("/message", requireBearerAuth({
  provider,
  requiredScopes: ["User.Read"]
}), async (req, res) => {
  // ... handle the message ...
});

// Handle the OAuth 2.0 callback
app.get("/auth/callback", (req, res) => {
  provider.handleCallback(req.query.code, req.query.state)
    .then(result => {
      // ... handle success or failure ...
    });
});
```

Alat `getUserDetails` u **Tools.ts** je sliƒçan prethodnom primjeru, ali pristupni token uzima iz sesije.

```typescript
// Simplified for clarity
server.setRequestHandler(CallToolRequestSchema, async (request) => {
  const { name } = request.params;
  const context = request.params?.context as { token?: string } | undefined;
  const sessionToken = context?.token;

  if (name === ToolName.GET_USER_DETAILS) {
    if (!sessionToken) {
      throw new AuthenticationError("Authentication token is missing or invalid. Ensure the token is provided in the request context.");
    }

    // Get the Entra ID token from the session store
    const tokenData = tokenStore.getToken(sessionToken);
    const entraIdToken = tokenData.accessToken;

    const graphClient = Client.init({
      authProvider: (done) => {
        done(null, entraIdToken);
      }
    });

    const user = await graphClient.api('/me').get();

    // ... return user details ...
  }
});
```

Kada se pozove alat `getUserDetails` u **auth/EntraIdServerAuthProvider.ts**, koristi se token iz sesije za pronalazak Entra ID pristupnog tokena, koji se potom koristi za poziv Microsoft Graph API-ja.

Ovaj tijek je slo≈æeniji od tijeka za javnog klijenta, ali je potreban za internetom dostupne endpointove. Buduƒái da su udaljeni MCP poslu≈æitelji dostupni preko javnog interneta, potrebne su sna≈ænije sigurnosne mjere kako bi se za≈°titili od neovla≈°tenog pristupa i potencijalnih napada.

## Najbolje sigurnosne prakse

- **Uvijek koristite HTTPS:** ≈†ifrirajte komunikaciju izmeƒëu klijenta i poslu≈æitelja kako biste za≈°titili tokene od presretanja.
- **Implementirajte kontrolu pristupa temeljenu na ulogama (RBAC):** Ne provjeravajte samo *je li* korisnik autentificiran, veƒá i *≈°to* mu je dopu≈°teno raditi. U Entra ID-u mo≈æete definirati uloge i provjeravati ih u MCP poslu≈æitelju.
- **Nadzor i revizija:** Bilje≈æite sve dogaƒëaje autentikacije kako biste mogli detektirati i reagirati na sumnjive aktivnosti.
- **Rukovanje ograniƒçenjima i usporavanjem zahtjeva:** Microsoft Graph i drugi API-ji imaju ograniƒçenja broja zahtjeva. Implementirajte eksponencijalni povratak i logiku ponovnog poku≈°aja u va≈°em MCP poslu≈æitelju za elegantno rukovanje HTTP 429 (Previ≈°e zahtjeva) odgovorima. Razmotrite ke≈°iranje ƒçesto kori≈°tenih podataka kako biste smanjili broj API poziva.
- **Sigurno pohranjivanje tokena:** Pristupne i osvje≈æavajuƒáe tokene pohranite sigurno. Za lokalne aplikacije koristite sustavne mehanizme za sigurnu pohranu. Za poslu≈æiteljske aplikacije razmotrite enkriptiranu pohranu ili usluge za upravljanje kljuƒçevima poput Azure Key Vaulta.
- **Rukovanje istekom tokena:** Pristupni tokeni imaju ograniƒçeno trajanje. Implementirajte automatsko osvje≈æavanje tokena pomoƒáu osvje≈æavajuƒáih tokena kako biste osigurali neprekidan korisniƒçki do≈æivljaj bez potrebe za ponovnom autentikacijom.
- **Razmislite o kori≈°tenju Azure API Managementa:** Iako implementacija sigurnosti direktno u MCP poslu≈æitelju pru≈æa detaljnu kontrolu, API Gateway rje≈°enja poput Azure API Managementa mogu automatski rije≈°iti mnoge sigurnosne izazove, ukljuƒçujuƒái autentikaciju, autorizaciju, ograniƒçavanje zahtjeva i nadzor. Oni pru≈æaju centralizirani sigurnosni sloj izmeƒëu va≈°ih klijenata i MCP poslu≈æitelja. Vi≈°e o kori≈°tenju API Gatewaya s MCP pogledajte u [Azure API Management Your Auth Gateway For MCP Servers](https://techcommunity.microsoft.com/blog/integrationsonazureblog/azure-api-management-your-auth-gateway-for-mcp-servers/4402690).

## Kljuƒçne spoznaje

- Osiguravanje MCP poslu≈æitelja kljuƒçno je za za≈°titu va≈°ih podataka i alata.
- Microsoft Entra ID pru≈æa sna≈æno i skalabilno rje≈°enje za autentikaciju i autorizaciju.
- Koristite **javni klijent** za lokalne aplikacije i **povjerljivi klijent** za udaljene poslu≈æitelje.
- **Authorization Code Flow** je najsigurnija opcija za web aplikacije.

## Vje≈æba

1. Razmislite o MCP poslu≈æitelju koji biste mogli izgraditi. Hoƒáe li biti lokalni ili udaljeni poslu≈æitelj?
2. Na temelju svog odgovora, biste li koristili javnog ili povjerljivog klijenta?
3. Koju bi dozvolu va≈° MCP poslu≈æitelj tra≈æio za izvoƒëenje radnji prema Microsoft Graphu?

## Praktiƒçne vje≈æbe

### Vje≈æba 1: Registracija aplikacije u Entra ID  
Idite na Microsoft Entra portal.  
Registrirajte novu aplikaciju za va≈° MCP poslu≈æitelj.  
Zabilje≈æite Application (client) ID i Directory (tenant) ID.

### Vje≈æba 2: Osigurajte lokalni MCP poslu≈æitelj (javni klijent)  
- Slijedite primjer koda za integraciju MSAL-a (Microsoft Authentication Library) za autentikaciju korisnika.  
- Testirajte tijek autentikacije pozivom MCP alata koji dohvaƒáa korisniƒçke podatke iz Microsoft Grapha.

### Vje≈æba 3: Osigurajte udaljeni MCP poslu≈æitelj (povjerljivi klijent)  
- Registrirajte povjerljivog klijenta u Entra ID i kreirajte klijentsku tajnu.  
- Konfigurirajte va≈° Express.js MCP poslu≈æitelj za kori≈°tenje Authorization Code Flow.  
- Testirajte za≈°tiƒáene endpointove i potvrdite pristup temeljen na tokenima.

### Vje≈æba 4: Primijenite najbolje sigurnosne prakse  
- Omoguƒáite HTTPS za va≈° lokalni ili udaljeni poslu≈æitelj.  
- Implementirajte kontrolu pristupa temeljenu na ulogama (RBAC) u logici poslu≈æitelja.  
- Dodajte rukovanje istekom tokena i sigurnu pohranu tokena.

## Resursi

1. **MSAL pregledna dokumentacija**  
   Saznajte kako Microsoft Authentication Library (MSAL) omoguƒáava sigurno dobivanje tokena na razliƒçitim platformama:  
   [MSAL Overview on Microsoft Learn](https://learn.microsoft.com/en-gb/entra/msal/overview)

2. **Azure-Samples/mcp-auth-servers GitHub repozitorij**  
   Referentne implementacije MCP poslu≈æitelja koji demonstriraju tijekove autentikacije:  
   [Azure-Samples/mcp-auth-servers on GitHub](https://github.com/Azure-Samples/mcp-auth-servers)

3. **Pregled Managed Identities za Azure resurse**  
   Razumite kako eliminirati tajne kori≈°tenjem sistemski ili korisniƒçki dodijeljenih upravljanih identiteta:  
   [Managed Identities Overview on Microsoft Learn](https://learn.microsoft.com/en-us/entra/identity/managed-identities-azure-resources/)

4. **Azure API Management: Va≈° Auth Gateway za MCP poslu≈æitelje**  
   Dubinski pregled kori≈°tenja APIM-a kao sigurnog OAuth2 gatewaya za MCP poslu≈æitelje:  
   [Azure API Management Your Auth Gateway For MCP Servers](https://techcommunity.microsoft.com/blog/integrationsonazureblog/azure-api-management-your-auth-gateway-for-mcp-servers/4402690)

5. **Microsoft Graph Permissions Reference**  
   Sveobuhvatan popis delegiranih i aplikacijskih dozvola za Microsoft Graph:  
   [Microsoft Graph Permissions Reference](https://learn.microsoft.com/zh-tw/graph/permissions-reference)

## Ishodi uƒçenja  
Nakon zavr≈°etka ovog dijela, moƒái ƒáete:

- Objasniti za≈°to je autentikacija kljuƒçna za MCP poslu≈æitelje i AI tijekove rada.  
- Postaviti i konfigurirati Entra ID autentikaciju za lokalne i udaljene MCP poslu≈æiteljske scenarije.  
- Izabrati odgovarajuƒái tip klijenta (javni ili povjerljivi) ovisno o implementaciji poslu≈æitelja.  
- Implementirati sigurne razvojne prakse, ukljuƒçujuƒái pohranu tokena i autorizaciju temeljenu na ulogama.  
- S pouzdanjem za≈°tititi svoj MCP poslu≈æitelj i njegove alate od neovla≈°tenog pristupa.

## ≈†to slijedi

- [5.13 Model Context Protocol (MCP) integracija s Azure AI Foundry](../mcp-foundry-agent-integration/README.md)

**Odricanje od odgovornosti**:  
Ovaj dokument preveden je kori≈°tenjem AI usluge prevoƒëenja [Co-op Translator](https://github.com/Azure/co-op-translator). Iako te≈æimo toƒçnosti, imajte na umu da automatski prijevodi mogu sadr≈æavati pogre≈°ke ili netoƒçnosti. Izvorni dokument na izvornom jeziku treba smatrati autoritativnim izvorom. Za va≈æne informacije preporuƒçuje se profesionalni ljudski prijevod. Ne odgovaramo za bilo kakva nesporazuma ili kriva tumaƒçenja koja proizlaze iz kori≈°tenja ovog prijevoda.